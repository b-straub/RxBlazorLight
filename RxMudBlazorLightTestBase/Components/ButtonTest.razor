<PageTitle>ButtonTest</PageTitle>

<MudStack>
    <MudText Typo="Typo.h3" GutterBottom="true">Counter</MudText>
    <MudText Typo="Typo.h3" GutterBottom="true">@Service.StateInfoState.Value?.State</MudText>

    <TimerComponent Name="Gobal" />
    <RxBLServiceScope TScope=@TimerService.TimerScope TService=@TimerService>
        <TimerComponent Name="ButtonTest" />
    </RxBLServiceScope>

    <MudText Class="mb-4">Current count: @Service.CountState.Value</MudText>

    <MudStack Row=@true AlignItems=@AlignItems.Center>
        <MudButtonRx Color="Color.Primary" Variant="Variant.Filled" StateProvider=@Service.Increment ConfirmExecutionAsync=@ConfirmIncrement>Increment</MudButtonRx>
        <MudButtonPRx Color="Color.Primary" Variant="Variant.Filled" ValueFactoryAsync=@DVFA.Factory(5) StateTransformer=@Service.Add>Add 5</MudButtonPRx>
        <MudButtonRx Color="Color.Secondary" Variant="Variant.Filled" StateProvider=@Service.IncrementAsync>IncrementAsync</MudButtonRx>
        <MudButtonPRx Color="Color.Secondary" Variant="Variant.Filled" StateTransformer=@Service.AddAsync ValueFactoryAsync=@DoPrepareAddAsync CancelColor=Color.Error CancelText="Cancel Add">
            AddAsync 2
        </MudButtonPRx>
    </MudStack>

    <MudStack Row=@true AlignItems=@AlignItems.Center>
        <MudMenu Label="Counter Menu">
            <MudMenuItemRx StateProvider=@Service.Increment ConfirmExecutionAsync=@ConfirmIncrement>Increment</MudMenuItemRx>
            <MudMenuItemPRx ValueFactoryAsync=@DVFA.Factory(5) StateTransformer=@Service.Add>Add 5</MudMenuItemPRx>
            <MudMenuItem OnClick=@(() => CmdDialogClick()) OnTouch=@(() => CmdDialogClick())>IncrementAsync</MudMenuItem>
            <MudMenuItem OnClick=@(() => CmdDialogClick(2)) OnTouch=@(() => CmdDialogClick(2))>AddAsync 2</MudMenuItem>
        </MudMenu>
    </MudStack>

    <MudStack Row=@true AlignItems=@AlignItems.Center>
        <MudFabRx Color="Color.Primary" StartIcon="@Icons.Material.Filled.PlusOne" StateProvider=@Service.Increment Label="Increment" />
        <MudFabPRx Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add" ValueFactoryAsync=@DVFA.Factory(5) StateTransformer=@Service.Add Label="Add 5" />
        <MudFabRx Color="Color.Secondary" EndIcon="@Icons.Material.Filled.PlusOne" StateProvider=@Service.IncrementAsync Label="IncrementAsync" />
        <MudFabPRx Color="Color.Secondary" EndIcon="@Icons.Material.Filled.Add" CancelText="Cancel Add" CancelColor=@Color.Error StateTransformer=@Service.AddAsync ValueFactoryAsync=@DoPrepareAddAsync Label="AddAsync 10" />
        <MudFabPRx Color="Color.Secondary" EndIcon="@Icons.Material.Filled.Add" StateTransformer=@Service.AddAsync ValueFactoryAsync=@DoPrepareAddAsync Label="AddAsync 10" />
    </MudStack>

    <RxBLServiceScope TScope=@TestService.SubScope TService=@TestService>
        <IconButtons />
    </RxBLServiceScope>

    <MudStack Row=@true AlignItems=@AlignItems.Center>
        <MudSwitchRx RxState=@Service.AddMode Label="Switch to Add mode" />
        <MudFabPRx Color="Color.Secondary" ValueFactoryAsync=@DoPrepareAddRemoveAsync
                       EndIcon=@(Service.AddMode.Value ? @Icons.Material.Filled.Add : Icons.Material.Filled.Remove)
                       StateTransformer=@Service.AddRemoveAsync />
    </MudStack>

    <MudStack Row=@true AlignItems=@AlignItems.Center>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick=@(() => CmdDialogClick())>Increment AsyncDialog</MudButton>
        <MudButton Color="Color.Secondary" Variant="Variant.Filled" OnClick=@(() => CmdDialogClick(10))>Add AsyncDialog 10</MudButton>
        <MudButton Color="Color.Warning" Variant="Variant.Filled" OnClick=@(() => Service.ChangeState("TEST1"))>Change State to Test1</MudButton>
        <MudButton Color="Color.Warning" Variant="Variant.Filled" OnClick=@(() => Service.ChangeState("TEST2"))>Change State to Test2</MudButton>
    </MudStack>

    <MudGrid>
        @if (Service.Exceptions.Any())
        {
            <MudItem xs="12">
                <MudText Typo="Typo.h5" GutterBottom="true">@GetExceptions()</MudText>
                <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick=@(() => Service.ResetExceptions())>Reset Exceptions</MudButton>
            </MudItem>
        }
        <MudItem xs="12">
            <MudFabRx Color="Color.Error" StartIcon="@Icons.Material.Filled.ErrorOutline" StateProvider=@Service.Exception Label="New Exception" />
        </MudItem>
    </MudGrid>
</MudStack>

@code {
    [CascadingParameter]
    public required TestService Service { get; init; }

    [Inject]
    public required IDialogService DialogService { get; init; }

    [Inject]
    public required ISnackbar Snackbar { get; init; }

    private async Task<bool> ConfirmIncrement()
    {
        ArgumentNullException.ThrowIfNull(DialogService);

        var parameters = new DialogParameters
            {
                ["Message"] = $"Increment counter?",
                ["ConfirmButton"] = "Increment"
            };

        var dialog = DialogService.Show<ConfirmDialog>("Counter", parameters);

        var res = await dialog.Result;

        if (res.Canceled)
        {
            return false;
        }

        return true;
    }

    private async Task DoPrepareAddAsync(IStateTransformer<int> st)
    {
        ArgumentNullException.ThrowIfNull(DialogService);
        var value = 10;

        var parameters = new DialogParameters
            {
                ["Message"] = $"Add {value} to counter?",
                ["ConfirmButton"] = "Add"
            };

        var dialog = DialogService.Show<ConfirmDialog>("Counter", parameters);

        var res = await dialog.Result;

        if (res.Canceled)
        {
            return;
        }

        st.Transform(value);
    }

    private async Task<bool> CmdDialogClick(int? parameter = null)
    {
        if (parameter is null)
        {
            return await DialogAsyncRx<TestService, int>.Show(DialogService, Service.IncrementAsync,
                "Increment", "Increment counter.", "Increment", "Cancel", false);
        }

        return await DialogAsyncPRx<TestService, int>.Show(DialogService, Service.AddAsync, DVFA.Factory((int)parameter),
            $"Add {parameter}", $"Add {parameter} to counter?", $"Add {parameter}", "Cancel", true, "Cancel adding!", Color.Error);
    }

    private async Task DoPrepareAddRemoveAsync(IStateTransformer<int> st)
    {
        var config = (SnackbarOptions options) =>
        {
            options.VisibleStateDuration = int.MaxValue;
            options.HideIcon = false;
        };

        const string sbKey = "AddRemoveSB";

        Snackbar.Configuration.PositionClass = Defaults.Classes.Position.TopCenter;
        Snackbar.Add($"Preparing AddRemove!", Severity.Info, config, sbKey);

        try
        {
            await Task.Delay(2000);
        }
        finally
        {
            Snackbar.RemoveByKey(sbKey);
        }

        var value = Math.Abs(Service.CountState.Value) * 5;

        if (value > 100 && Service.AddMode.Value)
        {
            return;
        }

        st.Transform(value);
    }

    private string GetExceptions()
    {
        return Service.Exceptions.Aggregate("", (p, n) => p + $"{n.Exception.Message} - {n.ID}, ").TrimEnd(new[] { ' ', ',' });
    }
}
